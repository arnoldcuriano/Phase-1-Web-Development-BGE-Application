<!-- projects.ejs -->
<!DOCTYPE html>
<html lang="en">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css">
   <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
   <link rel="stylesheet" href="https://cdn.datatables.net/1.10.21/css/jquery.dataTables.min.css">
   <link rel="preconnect" href="https://fonts.googleapis.com">
   <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
   <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500&display=swap" rel="stylesheet">
   <title>BGE Internal App</title>
   <link rel="icon" type="image/x-icon" href="images/bge-logo-favicon.png">
   <style>
      body {
         font-family: "Poppins", sans-serif;
         background-color: #f4f4f9;
         margin: 0;
         padding: 0;
         display: flex;
         height: 100vh;
      }
      .sidebar {
         width: 250px;
         background-color: #292929;
         color: white;
         height: 100vh;
         padding: 20px;
         box-sizing: border-box;
         position: fixed;
         top: 0;
         left: 0;
         display: flex;
         flex-direction: column;
      }
      .sidebar .logo {
         margin-bottom: 30px;
         text-align: center;
      }
      .sidebar .logo img {
         width: 80%;
      }
      .sidebar .profile {
         display: flex;
         align-items: center;
         margin-bottom: 30px;
         background-color: #1e1e1e;
         padding: 15px;
         border-radius: 8px;
      }
      .sidebar .profile img {
         border-radius: 50%;
         width: 60px;
         height: 60px;
         margin-right: 10px;
      }
      .sidebar .profile div {
         display: flex;
         flex-direction: column;
         align-items: flex-start;
         width: 100%;
      }
      .sidebar .profile div h3 {
         margin: 0;
         font-size: 16px;
      }
      .sidebar .profile div p {
         margin: 2px 0;
         font-size: 12px;
         color: #bbb;
      }
      .sidebar .profile div .role {
         background-color: #4caf50;
         color: white;
         padding: 2px 5px;
         border-radius: 5px;
         font-size: 12px;
      }
      .sidebar nav {
         display: flex;
         flex-direction: column;
      }
      .sidebar nav a {
         color: white;
         text-decoration: none;
         display: flex;
         align-items: center;
         padding: 10px 15px;
         margin: 5px 0;
         border-radius: 4px;
         transition: background 0.3s;
      }
      .sidebar nav a:hover {
         background-color: #34495e;
      }
      .sidebar nav a i {
         margin-right: 10px;
      }
      .content {
         margin-left: 270px;
         padding: 20px;
         box-sizing: border-box;
         flex: 1;
         overflow-y: auto;
      }
      .header {
         display: flex;
         justify-content: space-between;
         align-items: center;
         margin-bottom: 20px;
      }
      .header h1 {
         margin: 0;
      }
      .announcement-container {
            background-color: #e3f2fd;
            padding: 20px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            border: 1px solid #42a5f5;
        }
      .announcement-container p {
         margin: 0;
         flex: 1;
      }
      .overview, .metrics {
         display: flex;
         flex-wrap: wrap;
         gap: 20px;
         margin-bottom: 20px;
      }
      .card {
         background-color: white;
         padding: 20px;
         border-radius: 8px;
         box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
         flex: 1 1 calc(33.333% - 20px);
         box-sizing: border-box;
         justify-content: center;
         align-items: center;
         text-align: center;
      }
      .card.full-width {
         flex: 1 1 100%;
      }
      .card h3, .card h1 {
         margin: 0 0 10px 0;
      }
      .card p {
         margin: 5px 0;
      }
      .card button {
         background: linear-gradient(45deg, #34A853, #4285F4);
         border: none;
         color: white;
         padding: 10px;
         border-radius: 5px;
         cursor: pointer;
      }
      .clients-and-events {
         display: flex;
         gap: 20px;
         margin-bottom: 20px;
      }
      .table {
         width: 100%;
         border-collapse: collapse;
         margin-top: 10px;
      }
      .table th, .table td {
         border: 1px solid #ddd;
         text-align: center;
      }
      .table th {
         background-color: #f2f2f2;
      }
      .footer {
         text-align: right;
         margin-top: 20px;
      }
      .more-section {
         background-color: rgb(255, 255, 255);
         box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
         width: 405px;
         padding: 20px;
         color: rgb(0, 0, 0);
         border-radius: 8px;
      }
      .sections {
         border: 3px solid;
         border-image: linear-gradient(45deg, #34A853, #4285F4) 1;
         padding: 20px;
         border-radius: 8px;
      }
      .sections-header {
         display: flex;
         align-items: center;
         justify-content: space-between;
      }
      .sections-header h3,
      .sections-header span,
      .sections-header p {
         margin: 0;
      }
      .sections-header button {
         background: linear-gradient(45deg, #34A853, #4285F4);
         border: none;
         color: white;
         padding: 10px;
         border-radius: 5px;
         cursor: pointer;
      }
      .fourcards {
         background-color: red;
         display: flex;
         color: rgb(0, 0, 0);
         flex: 1;
      }
      .cardx {
         background-color: white;
         border-style: 1px solid;
      }
      .metrics .card {
         flex: 1 1 calc(25% - 20px);
      }
      .adbutton {
         background: linear-gradient(45deg, #34A853, #4285F4);
         border: none;
         color: white;
         padding-left: 10px;
         padding-right: 10px;
         padding-top: 5px;
         padding-bottom: 5px;
         border-radius: 5px;
      }
      .overview .card h3 {
         font-weight: bolder;
         font-size: 40px;
      }
      .search-container input {
         margin-right: 10px;
      }
      .bottom-menu {
         margin-top: auto;
      }
      .bottom-menu .nav-link img {
         width: 80px;
      }
      .btn-success {
         background-color: #4CAF50;
         border-color: #4CAF50;
      }
      .btn-secondary {
         background-color: #f1f3f5;
         color: #333;
         border: none;
      }
       /*Datatable Styling*/
       .file-link {
        display: flex;
        align-items: center;
        margin-bottom: 5px;
    }

    .file-link .file-name {
        margin-left: 5px;
    }

    .file-link i {
        font-size: 1.2em;
        color: #6c757d; /* Light gray icon color */
    }

    .file-link .file-name {
        font-weight: 500;
        color: #007bff; /* Blue color */
        cursor: pointer;
        text-decoration: none;
    }

    .file-link .file-name:hover {
        text-decoration: underline; /* Underline on hover for better UX */
    }
      
   </style>
   </head>
<body>
   <div class="sidebar">
      <div class="logo">
         <img src="/images/bge-logo-tr.png" alt="BGE Logo">
      </div>
      <div class="profile">
         <img src="<%= user.profilePicture %>" alt="Profile Picture">
         <div>
            <h3><%= user.name %></h3>
            <span class="role">Admin</span>
         </div>
      </div>
      <nav class="nav flex-column">
         <a class="nav-link text-white" href="/dashboard"><i class="fas fa-tachometer-alt me-2"></i>Dashboard</a>
         <a class="nav-link text-white" href="/hr-department"><i class="fa-solid fa-book-open-reader"></i> Management</a>
         <a class="nav-link text-white" href="/members"><i class="fa-solid fa-address-card"></i>Members</a>
         <a class="nav-link text-white" href="/departments"><i class="fa-solid fa-house"></i>Departments</a>
         <a class="nav-link text-white" href="/services"><i class="fa-solid fa-briefcase"></i>Services</a>
         <a class="nav-link text-white" href="/projects"><i class="fa-solid fa-folder-open"></i>Projects</a>
         <a class="nav-link text-white" href="/clients"><i class="fa-solid fa-user"></i>Clients</a>
         <a class="nav-link text-white" href="#"><i class="fa-solid fa-square-poll-vertical"></i>Reports</a>
      </nav>
      <div class="btn-group bg-primary">
         <button class="btn btn-secondary btn-sm dropdown-toggle" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
         IT Department
         </button>
         <div class="dropdown-menu p-1">
            <a class="dropdown-item" href="/it/item-inventory">Inventory</a>
            <a class="dropdown-item" href="/it/item-distributed">Item Distributed</a>
            <div class="dropdown-divider"></div>
            <a class="dropdown-item" href="/it/category-management">Category Management</a>
         </div>
      </div>
      <div class="bottom-menu">
         <a class="nav-link text-white" href="https://app.greatdayhr.com/" target="_blank">
            <img src="/images/GREAT-DAY-LOGO.png" alt="Time in - Time Out"><u>Attendance</u>   
         </a>
      </div>
   </div>
   <div class="content">
      <div class="header">
         <h1>Department: Digital Marketing</h1>
         <div>
            <span>Admin, <a href="/auth/logout">Logout</a></span>
         </div>
      </div>
      <div class="announcement-container">
         <p>Announcement: Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua...</p>
      </div>
      <!-- Main Content -->
      <div class="mt-5">
         <div class="d-flex justify-content-between align-items-center mb-3">
           <h2>Project List</h2>
           <div class="search-container d-flex ml-auto">
             <input type="text" id="searchInput" class="form-control mr-2" placeholder="Search">
             <button class="adbutton" id="addProjectBtn" style="width:100%">Add New Project</button>
           </div>
         </div>
         <table class="table table-striped">
           <thead>
             <tr>
               <th>#</th>
               <th>Project Name</th>
               <th>Description</th>
               <th>Department Handler</th>
               <th>Files</th>
               <th>Actions</th>
             </tr>
           </thead>
           <tbody id="projectTableBody">
             <% projects.forEach((project, index) => { %>
             <tr>
               <td><%= index + 1 %></td>
               <td><%= project.name %></td>
               <td><%= project.description %></td>
               <td><%= project.departmentHandler ? project.departmentHandler.name : '' %></td>
               <td>
                 <% project.fileUpload.forEach(file => { %>
                 <% const fileType = file.split('.').pop(); %>
                 <% let iconClass = ''; %>
                 <% if (['doc', 'docx'].includes(fileType)) { %>
                 <% iconClass = 'fa-file-word'; %>
                 <% } else if (['xls', 'xlsx'].includes(fileType)) { %>
                 <% iconClass = 'fa-file-excel'; %>
                 <% } else if (fileType === 'pdf') { %>
                 <% iconClass = 'fa-file-pdf'; %>
                 <% } %>
                 <% const fileName = file.split('-').slice(1).join('-'); %>
                 <a href="/projects/download/<%= project._id %>?file=<%= file %>" target="_blank">
                   <i class="fas <%= iconClass %>"></i> <%= fileName %>
                 </a>
                 <br>
                 <% }); %>
               </td>
               <td class="actions">
                 <button class="btn btn-success edit-btn" data-project='<%= JSON.stringify(project) %>'><i class="fa-solid fa-pen-to-square" style="color: #ffffff;"></i></button>
                 <button class="btn btn-danger delete-btn" data-project-id="<%= project._id %>"><i class="fa-solid fa-trash" style="color: #ffffff;"></i></button>
               </td>
             </tr>
             <% }) %>
           </tbody>
         </table>
   
         <!-- Pagination Controls -->
         <nav aria-label="Page navigation">
           <ul class="pagination">
             <% if (currentPage > 1) { %>
             <li class="page-item">
               <a class="page-link" href="?page=<%= currentPage - 1 %>" aria-label="Previous">
                 <span aria-hidden="true">&laquo;</span>
               </a>
             </li>
             <% } %>
             <% for (let i = 1; i <= totalPages; i++) { %>
             <li class="page-item <%= currentPage === i ? 'active' : '' %>">
               <a class="page-link" href="?page=<%= i %>"><%= i %></a>
             </li>
             <% } %>
             <% if (currentPage < totalPages) { %>
             <li class="page-item">
               <a class="page-link" href="?page=<%= currentPage + 1 %>" aria-label="Next">
                 <span aria-hidden="true">&raquo;</span>
               </a>
             </li>
             <% } %>
           </ul>
         </nav>
   
         <p>Total: <%= totalDepartments %> Departments</p>
       </div>
   
       <!-- Add Project Modal -->
       <div class="modal fade" id="addProjectModal" tabindex="-1" aria-labelledby="addProjectModalLabel" aria-hidden="true">
         <div class="modal-dialog" role="document">
           <div class="modal-content">
             <div class="modal-header">
               <h5 class="modal-title" id="addProjectModalLabel">Add Project</h5>
               <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
             </div>
             <form id="addProjectForm" enctype="multipart/form-data">
               <div class="modal-body">
                 <div class="form-group">
                   <label for="addProjectName">Project Name</label>
                   <input type="text" class="form-control" id="addProjectName" name="name" required>
                 </div>
                 <div class="form-group">
                   <label for="addProjectDescription">Description</label>
                   <input type="text" class="form-control" id="addProjectDescription" name="description" required>
                 </div>
                 <div class="form-group">
                   <label for="addProjectDepartmentHandler">Department Handler</label>
                   <select class="form-control" id="addProjectDepartmentHandler" name="departmentHandler" required>
                     <% departments.forEach(department => { %>
                     <option value="<%= department._id %>"><%= department.name %></option>
                     <% }) %>
                   </select>
                 </div>
                 <div class="form-group">
                   <label for="addProjectFileUpload">File Upload</label>
                   <input type="file" class="form-control" id="addProjectFileUpload" name="fileUpload" accept=".doc,.docx,.xls,.xlsx,.pdf" multiple>
                 </div>
               </div>
               <div class="modal-footer">
                 <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                 <button type="submit" class="adbutton">Add Project</button>
               </div>
             </form>
           </div>
         </div>
       </div>
   
       <!-- Edit Project Modal -->
       <div class="modal fade" id="editProjectModal" tabindex="-1" aria-labelledby="editProjectModalLabel" aria-hidden="true">
         <div class="modal-dialog" role="document">
           <div class="modal-content">
             <div class="modal-header">
               <h5 class="modal-title" id="editProjectModalLabel">Edit Project</h5>
               <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
             </div>
             <form id="editProjectForm" enctype="multipart/form-data">
               <div class="modal-body">
                 <input type="hidden" id="projectId" name="id">
                 <div class="form-group">
                   <label for="projectName">Project Name</label>
                   <input type="text" class="form-control" id="projectName" name="name" required>
                 </div>
                 <div class="form-group">
                   <label for="projectDescription">Description</label>
                   <input type="text" class="form-control" id="projectDescription" name="description" required>
                 </div>
                 <div class="form-group">
                   <label for="projectDepartmentHandler">Department Handler</label>
                   <select class="form-control" id="projectDepartmentHandler" name="departmentHandler" required>
                     <% departments.forEach(department => { %>
                     <option value="<%= department._id %>"><%= department.name %></option>
                     <% }) %>
                   </select>
                 </div>
                 <div class="form-group">
                   <label for="projectFileUpload">File Upload</label>
                   <input type="file" class="form-control" id="projectFileUpload" name="fileUpload" accept=".doc,.docx,.xls,.xlsx,.pdf" multiple>
                 </div>
               </div>
               <div class="modal-footer">
                 <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                 <button type="submit" class="btn btn-primary">Update Changes</button>
               </div>
             </form>
           </div>
         </div>
       </div>
   
       <%- include('partials/footer') %>
       <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
       <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
       <script>
         $(document).ready(function() {
           $('#addProjectBtn').on('click', function() {
             $('#addProjectModal').modal('show');
           });
   
           $('.edit-btn').on('click', function() {
             var project = $(this).data('project');
             $('#editProjectModal #projectId').val(project._id);
             $('#editProjectModal #projectName').val(project.name);
             $('#editProjectModal #projectDescription').val(project.description);
             $('#editProjectModal #projectDepartmentHandler').val(project.departmentHandler ? project.departmentHandler._id : '');
             
             if (project.fileUpload.length > 0) {
               var files = project.fileUpload.map(file => file.split('/').pop().split('-').slice(1).join('-')).join('<br>');
               $('#editProjectModal #currentFile').html('Current files:<br>' + files);
             } else {
               $('#editProjectModal #currentFile').text('No file currently uploaded');
             }
             
             $('#editProjectModal').modal('show');
           });
   
           $('.delete-btn').on('click', function() {
             var projectId = $(this).data('project-id');
             if (confirm('Are you sure you want to delete this project?')) {
               $.ajax({
                 url: '/projects/delete/' + projectId,
                 type: 'POST',
                 success: function(response) {
                   location.reload();
                 },
                 error: function(error) {
                   console.error('Delete failed', error);
                 }
               });
             }
           });
   
           $('#addProjectForm').on('submit', function(e) {
             e.preventDefault();
             var formData = new FormData(this);
             $.ajax({
               url: '/projects/add',
               type: 'POST',
               data: formData,
               contentType: false,
               processData: false,
               success: function(response) {
                 location.reload();
               },
               error: function(error) {
                 console.error('Add failed', error);
               }
             });
           });
   
           $('#editProjectForm').on('submit', function(e) {
             e.preventDefault();
             var formData = new FormData(this);
             
             if (formData.get('fileUpload').size === 0) {
               formData.delete('fileUpload');
             }
             
             $.ajax({
               url: '/projects/update',
               type: 'POST',
               data: formData,
               contentType: false,
               processData: false,
               success: function(response) {
                 location.reload();
               },
               error: function(error) {
                 console.error('Update failed', error);
               }
             });
           });
   
           $('#searchInput').on('keyup', function() {
             var value = $(this).val().toLowerCase();
             $('#projectTableBody tr').filter(function() {
               $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1);
             });
           });
         });
      </script>
   </div>
</body>
</html>
